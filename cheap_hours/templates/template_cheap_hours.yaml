#
# Unique settings for each device used
#
# This is for demo
#
# State: True when hour is cheap and chosen
#
# input_number.load_demo_nr_hours: Nr of hours to load, no more than max available spotprice hours can be chosen
# input_number.start_load_demo: If not set, timespan starts from current hour
# input_number.stop_load_demo: If not set, timespan stops at last available hour
# input_boolean.charge_only_today: If set, only hours today are included
#
# Attribute: displays chosen hours
#
- sensor:
    - name: "Load demo between hours"
      unique_id: load_demo_between_hours
      state: >-
          {% set cheap_hours = namespace(number=states('input_number.load_demo_nr_hours')|int(0)) %}
          {% set starthour = states('input_number.start_load_demo') %}
          {% set stophour = states('input_number.stop_load_demo') %}
          {% set from = starthour | int %}
          {% set today = now().day | int %}
          {% set ldom = states('sensor.last_day_this_month') | int %}         
          {% set startday = today %}

          {% if states('input_boolean.charge_only_today') == 'on'  %}
            {% set stopday = today %}
          {% else %}
            {% if today == ldom %}
              {% set stopday = 1 %}
            {% else %}
              {% set stopday = today + 1 %}
            {% endif %} 
          {% endif %}
          
          {%- set starttoday = startday | int == today %}
          {%- set stoptoday = stopday | int == today %}
          
          
          {% if (stoptoday and stophour | int > from) or (not stoptoday) %}
            {% set to = stophour | int %}
          {% else %}
            {% set to = 24 %}
          {% endif %}
          
          {%- set ns = namespace(hour_price=[], cheapest_hour=False) %}
          {%- set s = namespace(sorted=[]) %} 
          {%- set s2 = namespace(sorted=[]) %}  
          {%- set chosen = namespace(sorted=[]) %} 
          {%- set chosendict = namespace(sorted=[]) %}
          {%- set tod = state_attr('sensor.nordpool_kwh_se3_sek_3_10_0','raw_today') %}
         
          
          {% if state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==true 
          and stoptoday == False 
          and state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow")[0]!=None %}
          {%- set tom = state_attr('sensor.nordpool_kwh_se3_sek_3_10_0','raw_tomorrow') %}
            {% for i in range(from, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
              'price': tod[i].value,
              'day': tod[i].start.day
              }] %}
            {%- endfor -%}
            {% for i in range(0, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tom[i].start.hour, 
              'price': tom[i].value,
              'day': tom[i].start.day
              }] %}
            {%- endfor -%}
            {% elif (state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==false) or
             (state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==true and stoptoday == True) %}
              {% for i in range(from, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
              'price': tod[i].value,
              'day': tod[i].start.day
              }] %}
            {%- endfor -%}
            {%- else -%}
              {% for i in range(from, to) %}
                {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
                'price': tod[i].value,
                'day': tod[i].start.day
                }] %}
              {%- endfor -%}
            {% endif %}
            
            {% for item in ns.hour_price|sort(attribute="price") %}
              {% set s.sorted = s.sorted + [item] %}
            {% endfor %}
            {% set nr_hours = cheap_hours.number %}
            {% if cheap_hours.number | int > s.sorted|length %}
              {% set nr_hours = ns.hour_price|length %}
            {% elif cheap_hours.number | int == 0 %}
              {% set nr_hours = 3 %}
            {% else %}
              {% set nr_hours = cheap_hours.number | int %}
            {% endif %}
            {% for each in range(0, nr_hours) %}
              {% set h = s.sorted[each]['hour'] %}
              {% set d = s.sorted[each]['day'] %}
              {% set chosen.sorted = chosen.sorted + [(s.sorted[each])] %}
              {% if h == now().hour and d == now().day %}
                {% set ns.cheapest_hour = True %}
              {% endif %}
              {%- if not loop.last -%}{% endif %}
            {% endfor %}
            {{ ns.cheapest_hour }}
      attributes:
        chosen_hours: >-
          {% set cheap_hours = namespace(number=states('input_number.load_demo_nr_hours')|int(0)) %}
          {% set starthour = states('input_number.start_load_demo') %}
          {% set stophour = states('input_number.stop_load_demo') %}
          {% set from = starthour | int %}
          {% set today = now().day | int %}
          {% set ldom = states('sensor.last_day_this_month') | int %}         
          {% set startday = today %}

          {% if states('input_boolean.charge_only_today') == 'on'  %}
            {% set stopday = today %}
          {% else %}
            {% if today == ldom %}
              {% set stopday = 1 %}
            {% else %}
              {% set stopday = today + 1 %}
            {% endif %} 
          {% endif %}
          
          {%- set starttoday = startday | int == today %}
          {%- set stoptoday = stopday | int == today %}
          
          
          {% if (stoptoday and stophour | int > from) or (not stoptoday) %}
            {% set to = stophour | int %}
          {% else %}
            {% set to = 24 %}
          {% endif %}
      
          {%- set ns = namespace(hour_price=[]) %}
          {%- set s = namespace(sorted=[]) %} 
          {%- set s2 = namespace(sorted=[]) %}  
          {%- set chosen = namespace(sorted=[]) %} 
          {%- set chosendict = namespace(sorted=[]) %}
          {%- set tod = state_attr('sensor.nordpool_kwh_se3_sek_3_10_0','raw_today') %}
         
          {% if state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==true 
          and stoptoday == False 
          and state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow")[0]!=None %}
          {%- set tom = state_attr('sensor.nordpool_kwh_se3_sek_3_10_0','raw_tomorrow') %}
            {% for i in range(from, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
              'price': tod[i].value,
              'day': tod[i].start.day
              }] %}
            {%- endfor -%}
            {% for i in range(0, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tom[i].start.hour, 
              'price': tom[i].value,
              'day': tom[i].start.day
              }] %}
            {%- endfor -%}

            {% elif (state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==false) or
             (state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==true and stoptoday == True) %}
              {% for i in range(from, to) %}
              {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
              'price': tod[i].value,
              'day': tod[i].start.day
              }] %}
            {%- endfor -%}

            {%- else -%}
              {% for i in range(from, to) %}
                {% set ns.hour_price = ns.hour_price + [{'hour': tod[i].start.hour, 
                'price': tod[i].value,
                'day': tod[i].start.day
                }] %}
              {%- endfor -%}
            {% endif %}

            {% for user in ns.hour_price|sort(attribute="price") %}
              {% set s.sorted = s.sorted + [user] %}
            {% endfor %}

            {% set nr_hours = cheap_hours.number %}
            {% if cheap_hours.number | int > s.sorted|length %}
              {% set nr_hours = ns.hour_price|length %}
            {% else %}
              {% set nr_hours = cheap_hours.number | int %}
            {% endif %}

            {% for each in range(0, nr_hours) %}
              {% set h = s.sorted[each]['hour'] %}
              {% set d = s.sorted[each]['day'] %}
              {% set chosen.sorted = chosen.sorted + [(s.sorted[each])] %}
              {% if h == now().hour and d == now().day %}
                {% set ns.cheapest_hour = True %}
              {% endif %}
              {%- if not loop.last -%}{% endif %}
            {% endfor %}

            {% set sorted = chosen.sorted|sort(attribute='hour') %}
            {% set firstday = chosen.sorted|sort(attribute='day') %}
            {% set first = firstday[0]['day'] %}

            {% for item in range(0, sorted|length) %}
              {% set hour = sorted[item]['hour'] %}
              {% set day = sorted[item]['day'] %}
              {% set price = sorted[item]['price'] %}
              

              {% if sorted[item]['day'] == first %}
                {% set s2.sorted = s2.sorted + [{'day':day, 'hour':hour, 'price':price}] %}
               {% else %}
                 {% set chosendict.sorted = chosendict.sorted + [{'day':day, 'hour':hour, 'price':price}] %}
               {% endif %} 
            {% endfor %}
            {% set chosendict.sorted = s2.sorted + chosendict.sorted %}
            {{ chosendict.sorted }}





#
# Last day of current month
#
- sensor:
    - name: Last day this month
      unique_id: last_day_this_month
      state: >
        {% set thismonth = now().month %}
        {% set thisyear = now().year %}
        {%- macro last_dayofmonth(month, year) -%}
            {%- set daysinmonths = [31,28,31,30,31,30,31,31,30,31,30,31] -%}
            {%- set month = month|int -%}
            {%- set year = year|int -%}

            {# Simplified leap year calculation. See https://www.mathsisfun.com/leap-years.html #}
            {%- set isleapyear = year % 4 == 0 and (year % 100 != 0 or year % 400 == 0) -%}

            {%- set monthindex = month-1 -%}
            {%- if month == 2 and isleapyear -%}
                {{ daysinmonths[monthindex]+1 }}
            {%- else -%}
                {{ daysinmonths[monthindex] }}
            {%- endif -%}
        {%- endmacro -%}

        {% set last = last_dayofmonth(thismonth, thisyear)  %}
        {{ last }}


#
# State: visar dagens medelpris
#
# Attribut: Sorterade tillgängliga nordpoolpriser enligt pris med dag och tid
#
- sensor:
  - name: "Sorted and average"
    unique_id: sorted_and_average
    state: "{{ state_attr('sensor.nordpool_kwh_se3_sek_3_10_0','average') }}"
    attributes:
        hours: >
          {%- set ns = namespace(hour_price=[]) %}
          {%- set ns2 = namespace(hour_price2=[]) %}
          {% set ldom = states('sensor.last_day_this_month') | int %}
          
          {% if state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow_valid")==true and state_attr("sensor.nordpool_kwh_se3_sek_3_10_0", "tomorrow")[0]!=None %}
            {% for i in range(now().hour, 24) %}
              {% set when =  ' kl. ' + i| string + ' dag: ' + (now().day) | string %}
              {% set ns.hour_price = ns.hour_price + [(when, states.sensor.nordpool_kwh_se3_sek_3_10_0.attributes.raw_today[i].value)] %}
            {%- endfor -%}
            {% for i in range(0, 24) %}
              {% set tom = now().day + 1 %}
              {% if now().day == ldom %}
                {% set tom = 1 %}
              {% endif %}
              {% set when =  ' kl. ' + i| string + ' dag: ' + tom | string %}
              {% set ns.hour_price = ns.hour_price + [(when, states.sensor.nordpool_kwh_se3_sek_3_10_0.attributes.raw_tomorrow[i].value)] %}
            {%- endfor -%}

          {% else %}
             {% for i in range(now().hour, 24) %}
               {% set when =  ' kl. ' + i| string + ' dag: ' + (now().day) | string %}
              {% set ns.hour_price = ns.hour_price + [(when, states.sensor.nordpool_kwh_se3_sek_3_10_0.attributes.raw_today[i].value)] %}
            {%- endfor -%}
          {% endif %}
          
          {% set hour_price_dict = dict.from_keys(ns.hour_price) %}
          {% set sorted_hour_price_dict = hour_price_dict.items()|sort(attribute='1') %}
          {% for each in sorted_hour_price_dict %}
          {% set ns2.hour_price2 = ns2.hour_price2 + [(each[1], each[0])] %}
             {%- if not loop.last -%}{% endif %}
          {% endfor %}
          {{ ns2.hour_price2 }}